#!/bin/bash

# Function to upload file to Litterbox
upload_file() {
    FILE_PATH="$1"
    TIME="24h"
    CONF_FILE="$HOME/.config/.litterboxer.conf"

    # Check if config file exists and read expiration time
    if [ -f "$CONF_FILE" ]; then
        TIME=$(cat "$CONF_FILE")
    fi

    # Get file extension
    EXT="${FILE_PATH##*.}"

    # Blacklisted extensions by Litterbox
    BLACKLIST=("exe" "jar" "doc" "docx" "cpl" "scr")

    # Check if file size is greater than 1GB
    if [ $(stat -c%s "$FILE_PATH") -gt 1073741824 ]; then
        zenity --error --title="Error" --text="Only files less than 1GB are allowed."
        exit 1
    fi

    # Prepare data for upload
    if [ -d "$FILE_PATH" ]; then
        # If a directory, zip it
        ZIP_PATH="${FILE_PATH}.zip"
        zip -r "$ZIP_PATH" "$FILE_PATH"
        FILE_PATH="$ZIP_PATH"
    elif [[ " ${BLACKLIST[@]} " =~ " ${EXT} " ]]; then
        # If file extension is blacklisted, zip it
        ZIP_PATH="${FILE_PATH%.*}.zip"
        zip "$ZIP_PATH" "$FILE_PATH"
        FILE_PATH="$ZIP_PATH"
    fi

    # Upload the file
    RESPONSE=$(curl -s -F "reqtype=fileupload" -F "time=$TIME" -F "fileToUpload=@$FILE_PATH" "https://litterbox.catbox.moe/resources/internals/api.php")

    if [ -z "$RESPONSE" ]; then
        zenity --error --title="Error" --text="Failed to upload the file."
        exit 1
    fi

    # Display the result and copy to clipboard
    echo "$RESPONSE" | xclip -selection clipboard
    zenity --info --title="Upload Complete" --text="File uploaded successfully.\nLink: $RESPONSE\n(Link copied to clipboard)"
}

# Main script
for FILE in "$@"; do
    upload_file "$FILE"
done
